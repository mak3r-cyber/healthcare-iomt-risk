name: ci
on:
  push:
    branches: [main]
  pull_request:
jobs:
  qa:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: {python-version: '3.11'}
    - run: python -m pip install -U pip && pip install ruff black mypy pandas openpyxl
    - run: ruff check .
    - run: black --check .
    - run: mypy src
  build-artifacts:
    needs: qa
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: {python-version: '3.11'}
    - run: pip install pandas openpyxl
    - run: python tools/csv2xlsx.py
    - uses: actions/upload-artifact@v4
      with:
        name: risk-matrix-xlsx
        path: docs/reports/risk_matrix.xlsx
  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # Installer Syft
    - name: Install Syft
      run: |
        curl -sSfL https://github.com/anchore/syft/releases/download/v0.41.0/syft_0.41.0_linux_amd64.tar.gz | tar -xz -C /usr/local/bin

    # Installer Trivy
    - name: Install Trivy
      run: |
        curl -sfL https://github.com/aquasecurity/trivy/releases/download/v0.35.0/trivy_0.35.0_Linux-64bit.tar.gz | tar -xz -C /usr/local/bin

    # Lancer les vérifications de sécurité
    - run: bash tools/sec_checks.sh
